<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/uploads/favicon.ico?v=5.1.1" />






<meta name="description" content="持久层的概念和 Mybatis 的特点持久层：可以将业务数据存储到磁盘，具备长期存储的能力，只要磁盘不损坏，在断电或者其他情况下，重新开启系统任然可以进行读取这些数据。存储到磁盘的缺点：持久层可以使用巨大的磁盘空间，但是磁盘相对内存来说很慢，如在秒杀的没秒都需要执行成千上万的场景下，用磁盘极有可能宕机，再这样的场景下考虑使用 Redis （NoSQL）处理它。MyBatic 最大的成功主要有3点：">
<meta property="og:type" content="website">
<meta property="og:title" content="1.1MyBatis核心组件">
<meta property="og:url" content="http://yoursite.com/FarBox/xuhongliang.farbox.com/SSM+Redis/1.1MyBatis核心组件.html">
<meta property="og:site_name" content="离离原上草">
<meta property="og:description" content="持久层的概念和 Mybatis 的特点持久层：可以将业务数据存储到磁盘，具备长期存储的能力，只要磁盘不损坏，在断电或者其他情况下，重新开启系统任然可以进行读取这些数据。存储到磁盘的缺点：持久层可以使用巨大的磁盘空间，但是磁盘相对内存来说很慢，如在秒杀的没秒都需要执行成千上万的场景下，用磁盘极有可能宕机，再这样的场景下考虑使用 Redis （NoSQL）处理它。MyBatic 最大的成功主要有3点：">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-11-14T03:09:14.289Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="1.1MyBatis核心组件">
<meta name="twitter:description" content="持久层的概念和 Mybatis 的特点持久层：可以将业务数据存储到磁盘，具备长期存储的能力，只要磁盘不损坏，在断电或者其他情况下，重新开启系统任然可以进行读取这些数据。存储到磁盘的缺点：持久层可以使用巨大的磁盘空间，但是磁盘相对内存来说很慢，如在秒杀的没秒都需要执行成千上万的场景下，用磁盘极有可能宕机，再这样的场景下考虑使用 Redis （NoSQL）处理它。MyBatic 最大的成功主要有3点：">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '2826EPHU2B',
      apiKey: 'f88bfd768a4b086dc17a7c4946499618',
      indexName: '26fdb1447b8c93b980ce075eb0d6b7e9',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/FarBox/xuhongliang.farbox.com/SSM+Redis/1.1MyBatis核心组件.html"/>





  <title>1.1MyBatis核心组件 | 离离原上草</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?eee29daecf3c11799e28ab5768869fee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">离离原上草</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
  <header class="post-header">

	<h1 class="post-title" itemprop="name headline">1.1MyBatis核心组件</h1>



</header>

    
    
      <h1 id="持久层的概念和-Mybatis-的特点"><a href="#持久层的概念和-Mybatis-的特点" class="headerlink" title="持久层的概念和 Mybatis 的特点"></a>持久层的概念和 Mybatis 的特点</h1><p>持久层：可以将业务数据存储到磁盘，具备长期存储的能力，只要磁盘不损坏，在断电或者其他情况下，重新开启系统任然可以进行读取这些数据。<br>存储到磁盘的缺点：持久层可以使用巨大的磁盘空间，但是磁盘相对内存来说很慢，如在秒杀的没秒都需要执行成千上万的场景下，用磁盘极有可能宕机，再这样的场景下考虑使用 Redis （NoSQL）处理它。<br>MyBatic 最大的成功主要有3点：</p>
<ol>
<li>不屏蔽 SQL ，可以精确的定位 SQL 语句，可以对其进行优化和改造，利于性能的提高。</li>
<li>提供强大、灵活的映射机制。</li>
<li>提供了使用 Mapper 的接口编程，只要一个接口和一个 XML 就能创建映射器，简化操作。</li>
</ol>
<h1 id="准备-MyBatic-环境"><a href="#准备-MyBatic-环境" class="headerlink" title="准备 MyBatic 环境"></a>准备 MyBatic 环境</h1><p>下载：<a href="https://github.com/mybatis/mybatis-3/releases" target="_blank" rel="external">github地址</a><br>下载解压后，jar 包是项目工程包，lib 文件目录下放置的是 MyBatis 项目工程包所需依赖的第三方包。<br>要使用 MyBatis， 只需将 mybatis-x.x.x.jar 文件置于 classpath 中即可。<br>如果使用 Maven 来构建项目，则需将下面的 dependency 代码置于 pom.xml 文件中：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.x.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h1 id="MyBatis-的核心组件"><a href="#MyBatis-的核心组件" class="headerlink" title="MyBatis 的核心组件"></a>MyBatis 的核心组件</h1><p>核心组件分为四个部分：</p>
<ol>
<li>SqlSessionFactoryBuilder （构造器）<br> 根据配置或者代码来生成 SqlSessionFactory ，采用的是分步构建的 Builder 模式。</li>
<li>SqlSessionFactory （工厂接口）<br> 依靠它来生成 SqlSession，使用的是工厂模式。</li>
<li>SqlSession （会话）<br> 一个既可以发送 SQL 执行返回结果，也可以获取 Mapper 的接口。一般我们会让其在业务逻辑代码中“消失”，而使用 SQL Mapper 接口编程技术，它能提高代码的可读性和可维护性。</li>
<li>SQL Mapper （映射器）<br> 由一个 Java 接口和 XML 文件构成，需要给出对应的 SQL 的映射规则。它负责发送 SQL 去执行，并返回结果。</li>
</ol>
<p>SqlSession 和 SQL Mapper 都可以发送 SQL 到数据库并返回结果。</p>
<h1 id="SqlSessionFactory-（工厂接口）"><a href="#SqlSessionFactory-（工厂接口）" class="headerlink" title="SqlSessionFactory （工厂接口）"></a>SqlSessionFactory （工厂接口）</h1><p>MyBatis 提供构造器 SqlSessionFactoryBuilder ，提供一个类 Configuration 采用的是 Builder 模式作为引导，构建整个 Mybatis 的上下文。<br>SqlSessionFactory 由 DefaultSqlSessionFactory （具体实现）和 SqlSessionManager （多线程环境）实现。</p>
<h2 id="使用-XML-构建-SqlSessionFactory"><a href="#使用-XML-构建-SqlSessionFactory" class="headerlink" title="使用 XML 构建 SqlSessionFactory *"></a>使用 XML 构建 SqlSessionFactory *</h2><p>在 MyBatis 中的 XML 分为两类：</p>
<ul>
<li>基础配置文件，通常只有一个，配置一些基本的上下文参数和运行环境。</li>
<li>映射文件，配置映射关系、SQL、参数等信息。</li>
</ul>
<p>简易的 MyBatis 基础配置文件 mybatic-config.xml ：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></div><div class="line"><span class="meta">&lt;!DOCTYPE configuration   PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></div><div class="line"><span class="meta">  "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- 别名 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"com.learn.ssm.chapter3.pojo.Role"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 数据库环境 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/chapter3"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 映射文件 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/learn/ssm/chapter3/mapper/RoleMapper.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"com.learn.ssm.chapter3.mapper.RoleMapper2"</span>/&gt;</span> </div><div class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>描述一下 MyBatis 基础配置文件：</p>
<ul>
<li>typeAlias 元素定义了一个别名 role，它代表着 com.learn.ssm.chapter3.pojo.Role 这个类。定义后，MyBatis 上下文就可以使用别名来代替这个类。</li>
<li>environments 元素配置数据库环境，transactionManager 是配置事务管理器，这里采用的是 MyBatis 的 JDBC 管理器方式。dataSource 元素配置数据库，type=”POOLED” 表示采用 MyBatis 内部提供的连接池方式，最后定义一些 JDBC 的属性信息。</li>
<li>mappers 元素代表引入的那些映射器。配合映射文件完成数据库的映射。</li>
</ul>
<p>此时可以用简短的代码来生成 SqlSessionFactory<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">SqlSessionFactory sqlSessionFactory = <span class="literal">null</span>;</div><div class="line">String<span class="built_in"> resource </span>= <span class="string">"mybatic-config.xml"</span>;</div><div class="line">InputStream inputStream;</div><div class="line">try&#123;</div><div class="line">    inputStream = Resources.getResourceAsStream(resource);</div><div class="line">    sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">&#125; catch (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">｝</div></pre></td></tr></table></figure></p>
<p>首先读取 mybatic-config.xml ，然后通过 SqlSessionFactoryBuilder 的 build 方法创建SqlSessionFactory。</p>
<h2 id="使用代码创建-SqlSessionFactory"><a href="#使用代码创建-SqlSessionFactory" class="headerlink" title="使用代码创建 SqlSessionFactory"></a>使用代码创建 SqlSessionFactory</h2><p>和上面功能相同<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//数据库连接池信息</span></div><div class="line">PooledDataSource dataSource = <span class="keyword">new</span> <span class="type">PooledDataSource</span>();</div><div class="line">dataSource.setDriver(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">dataSource.setUsername(<span class="string">"root"</span>);</div><div class="line">dataSource.setPassword(<span class="string">"123456"</span>);</div><div class="line">dataSource.setUrl(<span class="string">"jdbc:mysql://localhost:3306/chapter3"</span>);</div><div class="line">dataSource.setDefaultAutoCommit(<span class="literal">false</span>);</div><div class="line"><span class="comment">//采用MyBatis的JDBC事务方式</span></div><div class="line">TransactionFactory transactionFactory = <span class="keyword">new</span> <span class="type">JdbcTransactionFactory</span>();</div><div class="line">Environment environment = <span class="keyword">new</span> <span class="type">Environment</span>(<span class="string">"development"</span>, transactionFactory, dataSource);</div><div class="line"><span class="comment">//创建Configuration对象</span></div><div class="line">Configuration configuration = <span class="keyword">new</span> <span class="type">Configuration</span>(environment);</div><div class="line"><span class="comment">//注册一个MyBatis上下文别名</span></div><div class="line">configuration.getTypeAliasRegistry().registerAlias(<span class="string">"role"</span>, Role.class);</div><div class="line"><span class="comment">//加入一个映射器</span></div><div class="line">configuration.addMapper(RoleMapper.class);</div><div class="line">configuration.addMapper(RoleMapper2.class);</div><div class="line"></div><div class="line"><span class="comment">//使用SqlSessionFactoryBuilder构建SqlSessionFactory</span></div><div class="line">sqlSessionFactory =  <span class="keyword">new</span> <span class="type">SqlSessionFactoryBuilder</span>().build(configuration);</div><div class="line"><span class="keyword">return</span> sqlSessionFactory;</div></pre></td></tr></table></figure></p>
<p>使用代码会导致代码冗长，在特殊情况下才会用代码方式创建 SqlSessionFactory。</p>
<h1 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h1><p>SqlSession 的作用类似于一个 JDBC 中的 Connection 对象，代表着一个连接资源的启用。</p>
<ul>
<li>获取 Mapper 接口。</li>
<li>发送 SQL 给数据库。</li>
<li>控制数据库事务。</li>
</ul>
<h2 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义</span></div><div class="line">SqlSession sqlSession = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">//打开会话</span></div><div class="line">	sqlSession = SqlSessionFactoryUtils.openSqlSession();</div><div class="line">	<span class="comment">//代码</span></div><div class="line">	sqlSession.commit();<span class="comment">//提交事务</span></div><div class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> ex)｛</div><div class="line">    sqlSession.rollback();<span class="comment">//回滚事务</span></div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="comment">//确保资源顺利关闭</span></div><div class="line">	<span class="keyword">if</span> (sqlSession != <span class="keyword">null</span>) &#123;</div><div class="line">		sqlSession.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h1><p>最重要、最复杂的组件，可以配置以下内容：</p>
<ul>
<li>描述映射规则。</li>
<li>提供 SQL 语句，并可以配置 SQL 参数类型、返回类型、缓存刷新等信息。</li>
<li>配置缓存。</li>
<li>提供动态 SQL。</li>
</ul>
<p>在实现映射器之前，需要定义一个 POJO：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.learn.ssm.chapter3.pojo;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Long id;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">String</span> roleName;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">String</span> note;</div><div class="line">	<span class="comment">/**setter and getter**/</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>作用：</p>
<ul>
<li>将 SQL 查询到的结果映射为一个 POJO</li>
<li>将 POJO 的数据插入到数据库中</li>
<li>定义一些缓存</li>
</ul>
<h2 id="用-XML-实现映射器"><a href="#用-XML-实现映射器" class="headerlink" title="用 XML 实现映射器 *"></a>用 XML 实现映射器 *</h2><p>分为两个部分：接口和XML</p>
<p>映射器接口：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public<span class="built_in"> interface </span>RoleMapper &#123;</div><div class="line">	public Role getRole(Long id);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>XML：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></span></div><div class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span></div><div class="line"><span class="xml">  "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="xml">//namespace 对应接口的全限定名</span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.learn.ssm.chapter3.mapper.RoleMapper"</span>&gt;</span></span></div><div class="line"><span class="xml">    //select 表明这是一条查询语句</span></div><div class="line"><span class="xml">    //id 标识了这跳 sql</span></div><div class="line"><span class="xml">    //parameterType 说明传递参数的类型</span></div><div class="line"><span class="xml">    //resultType 定义返回值了类型，此处 role 是类的别名</span></div><div class="line"><span class="xml">    //#</span><span class="template-variable">&#123;id&#125;</span><span class="xml"> 表示传递进去的参数</span></div><div class="line"><span class="xml">    //role_name as roleName MyBatic 默认下提供自动映射，只要 SQL 返回的列名和 POJO 对应起来即可。</span></div><div class="line"><span class="xml">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span></div><div class="line"><span class="xml">		select id, role_name as roleName, note from t_role where id = #</span><span class="template-variable">&#123;id&#125;</span><span class="xml"></span></div><div class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></div></pre></td></tr></table></figure></p>
<p>有了这两个文件，再加上 MyBatis 基础配置文件中的代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/learn/ssm/chapter3/mapper/RoleMapper.xml"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>此时完成了映射器的定义。</p>
<h2 id="注解实现映射器"><a href="#注解实现映射器" class="headerlink" title="注解实现映射器"></a>注解实现映射器</h2><p>通过注解省略 XML 文件，在接口中定义映射器。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public<span class="built_in"> interface </span>RoleMapper2 &#123;</div><div class="line">	@Select(<span class="string">"select id, role_name as roleName, note from t_role where id=#&#123;id&#125;"</span>)</div><div class="line">	public Role getRole(Long id);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再加上 MyBatis 基础配置文件中的代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"com.learn.ssm.chapter3.mapper.RoleMapper2"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="用-Mapper-接口发送-SQL"><a href="#用-Mapper-接口发送-SQL" class="headerlink" title="用 Mapper 接口发送 SQL *"></a>用 Mapper 接口发送 SQL *</h2><p>sqlSession 可以获取 Mapper 接口，通过 Mapper 接口发送 SQL<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">RoleMapper roleMapper</span> = sqlSession.getMapper(RoleMapper.class);</div><div class="line"><span class="attribute">Role role</span> = roleMapper.getRole(1L);</div></pre></td></tr></table></figure></p>
<p>通过“类的全限定名+方法名”执行接口的实现方法，启用对应的 SQL进行运行，并返回结果</p>
<h2 id="SqlSession-发送-SQL"><a href="#SqlSession-发送-SQL" class="headerlink" title="SqlSession 发送 SQL"></a>SqlSession 发送 SQL</h2><p>此时有了映射器，就可以通过 SqlSession 发送 SQL 了：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Role</span> <span class="title">role</span> = (Role)sqlSession.</div><div class="line">    selectOne(<span class="string">"com.learn.ssm.chapter3.mapper.RoleMapper.getRole"</span>,<span class="number">1</span>L);</div></pre></td></tr></table></figure></p>
<p>不推荐这个方法</p>
<h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><p>生命周期是组件的重要问题，尤其实在多线程的环境中。<br>生命周期就是每一个对象因该存活的时间，用完之后就要关闭，被 JVM 销毁，避免占用资源，所以要为每一个组件的作用去确定其生命周期。</p>
<h2 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h2><p>用于创建 SqlSessionFactory ，创建成功后就失去了作用，只存在创建 SqlSessionFactory 方法中。</p>
<h2 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h2><p>被认为是一个数据库连接池，作用是创建 SqlSession 接口对象。<br>MyBatis 的本质就是 Java 对数据库的操作，所以 SqlSessionFactory 的生命周期存在于整个 MyBatis 的应用中。<br>在一个 MyBatis 中以单例存在。</p>
<h2 id="SqlSession-1"><a href="#SqlSession-1" class="headerlink" title="SqlSession"></a>SqlSession</h2><p>相当于数据库的连接，存活在一个业务请求中，处理完整个请求后，应该关闭这条连接，归还给 SqlSessionFactory。</p>
<h2 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h2><p>是一个接口，由 SqlSession 创建，他的声明周期应该小于 SqlSession，因为 SqlSession 关闭后，它的数据库资源也会消失。</p>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><h2 id="单例创建-SqlSessionFactory"><a href="#单例创建-SqlSessionFactory" class="headerlink" title="单例创建 SqlSessionFactory"></a>单例创建 SqlSessionFactory</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Class&lt;SqlSessionFactoryUtils&gt; LOCK = SqlSessionFactoryUtils.class;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtils</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">SqlSessionFactory <span class="title">getSqlSessionFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">synchronized</span> (LOCK) &#123;</div><div class="line">		<span class="keyword">if</span> (sqlSessionFactory != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> sqlSessionFactory;</div><div class="line">		&#125;</div><div class="line">		String resource = <span class="string">"mybatis-config.xml"</span>;</div><div class="line">		InputStream inputStream;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			inputStream = Resources.getResourceAsStream(resource);</div><div class="line">			sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> sqlSessionFactory;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">SqlSession <span class="title">openSqlSession</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (sqlSessionFactory == <span class="keyword">null</span>) &#123;</div><div class="line">		getSqlSessionFactory();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">return</span> sqlSessionFactory.<span class="title">openSession</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用 private 关键字，使得其他代码不能通过 new 的方式来创建它。</li>
<li>使用 synchronized 关键字加锁，防止在多线程中多次实例化 SqlSessionFactory 对象，保证唯一性。</li>
<li>openSqlSession 方法创建 SqlSession 对象。</li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> testRoleMapper() &#123;</div><div class="line">	Logger log = Logger.getLogger(Chapter3Main.<span class="keyword">class</span>);</div><div class="line">	SqlSession sqlSession = <span class="literal">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		sqlSession = SqlSessionFactoryUtils.openSqlSession();</div><div class="line">		RoleMapper roleMapper = sqlSession.getMapper(RoleMapper.<span class="keyword">class</span>);</div><div class="line">		Role role = roleMapper.getRole(<span class="number">1L</span>);</div><div class="line">		log.info(role.getRoleName());</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="keyword">if</span> (sqlSession != <span class="literal">null</span>) &#123;</div><div class="line">			sqlSession.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用方法：</p>
<ul>
<li>通过 SqlSession 获取 RoleMapper 接口对象</li>
<li>通过 getRole 方法获取 Role 对象</li>
<li>通过 SqlSession 的 close 方法关闭 SqlSession</li>
</ul>

    
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="徐宏亮" />
          <p class="site-author-name" itemprop="name">徐宏亮</p>
           
              <p class="site-description motion-element" itemprop="description">我要用尽所有的力气才能书写一个词，放弃。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xuhongliang1996" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#持久层的概念和-Mybatis-的特点"><span class="nav-number">1.</span> <span class="nav-text">持久层的概念和 Mybatis 的特点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#准备-MyBatic-环境"><span class="nav-number">2.</span> <span class="nav-text">准备 MyBatic 环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-的核心组件"><span class="nav-number">3.</span> <span class="nav-text">MyBatis 的核心组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SqlSessionFactory-（工厂接口）"><span class="nav-number">4.</span> <span class="nav-text">SqlSessionFactory （工厂接口）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-XML-构建-SqlSessionFactory"><span class="nav-number">4.1.</span> <span class="nav-text">使用 XML 构建 SqlSessionFactory *</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用代码创建-SqlSessionFactory"><span class="nav-number">4.2.</span> <span class="nav-text">使用代码创建 SqlSessionFactory</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SqlSession"><span class="nav-number">5.</span> <span class="nav-text">SqlSession</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建方法"><span class="nav-number">5.1.</span> <span class="nav-text">创建方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#映射器"><span class="nav-number">6.</span> <span class="nav-text">映射器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#用-XML-实现映射器"><span class="nav-number">6.1.</span> <span class="nav-text">用 XML 实现映射器 *</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注解实现映射器"><span class="nav-number">6.2.</span> <span class="nav-text">注解实现映射器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用-Mapper-接口发送-SQL"><span class="nav-number">6.3.</span> <span class="nav-text">用 Mapper 接口发送 SQL *</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SqlSession-发送-SQL"><span class="nav-number">6.4.</span> <span class="nav-text">SqlSession 发送 SQL</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生命周期"><span class="nav-number">7.</span> <span class="nav-text">生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SqlSessionFactoryBuilder"><span class="nav-number">7.1.</span> <span class="nav-text">SqlSessionFactoryBuilder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SqlSessionFactory"><span class="nav-number">7.2.</span> <span class="nav-text">SqlSessionFactory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SqlSession-1"><span class="nav-number">7.3.</span> <span class="nav-text">SqlSession</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mapper"><span class="nav-number">7.4.</span> <span class="nav-text">Mapper</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实例"><span class="nav-number">8.</span> <span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#单例创建-SqlSessionFactory"><span class="nav-number">8.1.</span> <span class="nav-text">单例创建 SqlSessionFactory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试"><span class="nav-number">8.2.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">徐宏亮</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  

  

  

  

  

</body>
</html>
